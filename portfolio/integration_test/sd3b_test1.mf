;; 18-648 Fall 2012
;; Team 2
;; Nick Mazurek (nmazurek)
;; Jacob Olson (jholson)
;; Ben Clark (brclark)
;; Nipunn Koorapati (nkoorapa)
;; @file sd3b_test1.mf

; Integration test for SD#3B

#INCLUDE defines.mf
#DEFINE MESSAGE_PERIOD 0ms

; Set the back doors to closed
;0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = True 
;0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = True

;; Pre-Condition for DoorControl is at State 3: so get to state3
; mAtFloor == True && mAtFloor.f == mDesiredFloor.f
0s I MESSAGE_PERIOD N DESIRED_FLOOR_CAN_ID DesiredFloor = 1 FRONT STOP
0s I MESSAGE_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = True
; mDriveSpeed == Stop Stop
0s I MESSAGE_PERIOD N DRIVE_SPEED_CAN_ID DriveSpeed = 0 STOP
0s I 0s N DESIRED_DWELL_[FRONT]_CAN_ID DesiredDwell = 5000

;; Pre-Condition for DriveControl at a floor
0s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = True
0s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = True


; Pre-Conditions <doors are open and car is at hallway f,b>
+50ms I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][RIGHT]_CAN_ID DoorOpened FRONT RIGHT = True
+0ms I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID DoorOpened FRONT LEFT = True

;#arc '3B/1' Passenger enters;
;#arc '3B/2a' mCarWeight  is greater than MaxCarCapacity
+100ms I MESSAGE_PERIOD N CAR_WEIGHT_CAN_ID CarWeight = 14001

; Observe that doors are still opened
+10ms A N DOOR_MOTOR_COMMAND_[FRONT][LEFT]_CAN_ID DoorMotor FRONT LEFT : getDoorCommand == STOP
+0ms A N DOOR_MOTOR_COMMAND_[FRONT][RIGHT]_CAN_ID DoorMotor FRONT RIGHT : getDoorCommand == STOP
+0ms A F DoorMotor FRONT LEFT : command == STOP 
+0ms A F DoorMotor FRONT RIGHT : command == STOP 

;#arc '3B/2b' CarWeightAlarm = True (doesn't affect any modules so we don't need to set it)
+0ms I MESSAGE_PERIOD N CAR_WEIGHT_ALARM_CAN_ID CarWeightAlarm = True

;#arc '3B/2c' Assure drive is set to stop when overweight
+100ms A F Drive : speed == STOP
+0ms A F Drive : direction == STOP

;#arc '3B/3a' CarWeightAlarm = True to passenger
;#arc '3B/3b' Passenger exits
 
;#arc '3B/4a' Car weight decreases
+10ms I MESSAGE_PERIOD N CAR_WEIGHT_CAN_ID CarWeight = 13899

;#arc '3B/4b' CarWeightAlarm = False
;#arc '3B/4c'
+10ms I MESSAGE_PERIOD N CAR_WEIGHT_ALARM_CAN_ID CarWeightAlarm = False

;#arc '3B/4d' DoorMotor Set to close
+5100ms A N DOOR_MOTOR_COMMAND_[FRONT][LEFT]_CAN_ID DoorMotor FRONT LEFT : getDoorCommand == CLOSE
+0ms A N DOOR_MOTOR_COMMAND_[FRONT][RIGHT]_CAN_ID DoorMotor FRONT RIGHT : getDoorCommand == CLOSE
+0ms A F DoorMotor FRONT LEFT : command == CLOSE 
+0ms A F DoorMotor FRONT RIGHT : command == CLOSE 

;#arc '3B/4e' DoorClosed is True
+0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = True
+0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = True
+0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = True 
+0ms I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = True
+0ms I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][RIGHT]_CAN_ID DoorOpened FRONT RIGHT = False
+0ms I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID DoorOpened FRONT LEFT = False

; Set Desired Floor to a different position to prevent 
+0ms I MESSAGE_PERIOD N DESIRED_FLOOR_CAN_ID DesiredFloor = 2 BACK UP

;#arc '3B/4f' Assert that the State is State 1 and DoorMotors are stopped
+100ms A N DOOR_MOTOR_COMMAND_[FRONT][LEFT]_CAN_ID DoorMotor FRONT LEFT : getDoorCommand == STOP
+0ms A N DOOR_MOTOR_COMMAND_[FRONT][RIGHT]_CAN_ID DoorMotor FRONT RIGHT : getDoorCommand == STOP
+0ms A F DoorMotor FRONT LEFT : command == STOP
+0ms A F DoorMotor FRONT RIGHT : command == STOP 
